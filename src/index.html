<h1>Home</h1>

<div id="container"></div>

<button onclick="creatIframe()">Transfer</button>

<script>
  const phoneNumber = "07123345567";

  function removeIframe() {
    document.getElementById("passwordless-iframe").remove();
  }

  function removeListenForToken() {
    console.log("removeListenForToken");
    window.removeEventListener("message", listenForToken, false);
  }

  function handleToken(event) {
    console.log("handleToken");
    console.log(`Token: ${event.data}`);
    removeListenForToken();
    removeIframe();
  }

  function listenForToken() {
    console.log("listenForToken");
    window.addEventListener("message", handleToken, false);
  }

  function removeListenForIframeLoaded() {
    console.log("removeListenForIframeLoaded");
    window.removeEventListener("message", handleIframeLoaded, false);
  }

  function handleIframeLoaded(event) {
    console.log("handleIframeLoaded", event.data);
    removeListenForIframeLoaded();
    const iframe = document.getElementById("passwordless-iframe");
    iframe.contentWindow.postMessage({ type: "phoneNumber", data: phoneNumber }, window.location.origin);
    listenForToken();
  }

  function listenForIframeLoaded() {
    console.log("listenForIframeLoaded");
    window.addEventListener("message", handleIframeLoaded, false);
  }

  function creatIframe() {
    const ELEMENT_container = document.getElementById("container");
    const ELEMENT_iframe = document.createElement("iframe");
    ELEMENT_iframe.id = "passwordless-iframe";
    ELEMENT_iframe.src = "/passwordless";
    ELEMENT_iframe.width = "500";
    ELEMENT_iframe.height = "500";

    ELEMENT_container.appendChild(ELEMENT_iframe);

    listenForIframeLoaded();
  }
</script>